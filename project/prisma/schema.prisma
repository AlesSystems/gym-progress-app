generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String    @id @default(cuid())
  name            String?
  displayName     String?
  email           String    @unique
  emailVerified   DateTime?
  password        String?
  image           String?
  unitPreference  String    @default("kg")
  invitedBy       String?
  inviteCode      String    @unique @default(cuid())
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  workouts        Workout[]
  teamMemberships TeamMember[]
  inviter         User?      @relation("InvitedBy", fields: [invitedBy], references: [id])
  invitees        User[]     @relation("InvitedBy")
  invites         Invite[]
  maxLifts        MaxLift[]
  exercises       Exercise[] @relation("ExerciseCreator")
  templates       WorkoutTemplate[]

  @@index([email])
}

model Workout {
  id        String   @id @default(cuid())
  userId    String
  name      String
  date      DateTime
  notes     String?
  duration  Int?     // in minutes
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercises WorkoutExercise[]

  @@index([userId])
  @@index([date])
}

model Exercise {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  type             String   @default("compound")     // compound | isolation
  movementCategory String   @default("other")         // push | pull | legs | core | cardio | other
  primaryMuscle    String   @default("")
  secondaryMuscles Json     @default("[]")
  defaultUnit      String?                             // kg | lb
  defaultReps      Int?
  defaultWeight    Decimal? @db.Decimal(6, 2)
  demoImageUrl     String?
  demoVideoUrl     String?
  description      String?
  isSystemExercise Boolean  @default(false)
  isDeleted        Boolean  @default(false)
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  creator               User?                     @relation("ExerciseCreator", fields: [createdBy], references: [id])
  workoutExercises      WorkoutExercise[]
  maxLifts              MaxLift[]
  templateExercises     WorkoutTemplateExercise[]

  @@unique([name, createdBy])
  @@index([slug])
  @@index([movementCategory])
  @@index([type])
  @@index([createdBy])
  @@index([isSystemExercise])
}

model WorkoutExercise {
  id         String   @id @default(cuid())
  workoutId  String
  exerciseId String
  order      Int
  notes      String?

  workout  Workout    @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise   @relation(fields: [exerciseId], references: [id])
  sets     ExerciseSet[]

  @@index([workoutId])
}

model ExerciseSet {
  id                String  @id @default(cuid())
  workoutExerciseId String
  setNumber         Int
  weight            Float?
  reps              Int?
  duration          Int?    // in seconds
  distance          Float?
  notes             String?

  workoutExercise WorkoutExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)

  @@index([workoutExerciseId])
}

model Team {
  id        String   @id @default(cuid())
  name      String
  inviteCode String  @unique @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members TeamMember[]

  @@index([inviteCode])
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     String   @default("member") // "admin" | "member"
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model VerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique @default(cuid())
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
}

model Invite {
  id          String    @id @default(cuid())
  code        String    @unique @default(cuid())
  createdBy   String
  usedBy      String?
  expiresAt   DateTime?
  usedAt      DateTime?
  maxUses     Int?
  currentUses Int       @default(0)
  createdAt   DateTime  @default(now())

  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([createdBy])
}

model MagicLink {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique @default(cuid())
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([email])
}

model MaxLift {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String
  weight     Float
  unit       String   @default("kg")
  achievedAt DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id])

  @@unique([userId, exerciseId])
  @@index([userId])
}

model WorkoutTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  isArchived  Boolean  @default(false)
  clonedFrom  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  original  WorkoutTemplate?          @relation("TemplateClones", fields: [clonedFrom], references: [id])
  clones    WorkoutTemplate[]         @relation("TemplateClones")
  exercises WorkoutTemplateExercise[]

  @@index([userId])
  @@index([isArchived])
}

model WorkoutTemplateExercise {
  id               String   @id @default(cuid())
  templateId       String
  exerciseId       String
  orderIndex       Int
  sets             Int      @default(3)
  reps             String   @default("8-12")
  targetWeight     Decimal? @db.Decimal(6, 2)
  targetWeightUnit String?
  restSeconds      Int?
  tempoNotes       String?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  template WorkoutTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  exercise Exercise        @relation(fields: [exerciseId], references: [id])

  @@unique([templateId, orderIndex])
  @@index([templateId])
}

